---
layout: post
title: 一、FFmpeg——音视频基础
categories: FFmpeg
tags: [FFmpeg]
---

## 1 颜色空间

计算机中存储的任意类型图像都需要遵循一定的数据描述方式，这种描述方式被称为颜色空间。颜色空间类型非常多，我以下图为例详细讲解图像的颜色空间。

![alt text](/assets/FFmpeg/01_VideoBasic/image/image-2.png)

### 1.1 RGB颜色空间

对设计稍有了解的都会熟悉这种颜色空间，这种颜色空间是计算机屏幕显示的最直观的颜色空间。这种颜色空间的来源是因为，最初的物理科学家发现，通过红、绿、蓝光的不同强弱的组合几乎能表现出任意类型的光的颜色，所以后来计算机屏幕上每个像素点都会有这三种颜色的小灯，通过控制灯的强弱来制造出所有颜色。其中红色代表Red，绿色代表Green，蓝色代表Blue。

但这种方式有一个问题在于，一个像素点亮度从没有光到最亮，需要定义多少个颜色值呢？经过科学家反复测算，最终发现，定义256个值，可以表达16777216种颜色，能达到人类视觉的极限。所以现在的屏幕颜色及亮度均使用这种RGB24的方式来表达颜色。24代表取值24位，也就是每种颜色8位，分别取值为0-255。

下面我将RGB颜色给拆开：

![alt text](/assets/FFmpeg/01_VideoBasic/image/image-3.png)

由此可见，上图中红色区域在下图红色图片相同区域最亮；蓝色区域在下图蓝色图片相同区域最亮。绿色不太好对比，但可见黄色，这种颜色是通过红色和绿色组成，所以黄色区域在下图红色和绿色图片相同区域都比较亮。

一张 1280 * 720 大小的图片（每个像素点占用24bit），就占用 1280 * 720 * 3 / 1024 / 1024 = 2.63 MB 存储空间。

### 1.2 YUV颜色空间

这种颜色空间是视频格式的主要的颜色空间，与RGB一样，这种颜色空间也能表示任意颜色。这种颜色空间有非常多种标准，但无一例外均可以通过RGB颜色值的运算得到，可以把这种颜色空间与RGB的关系想象为这样：RGB为立体坐标系的xyz轴正方向向量，YUV为这个坐标系上三个不处在统一平面的三个向量，通过数学原理，YUV就能与RGB互相转换了。

这种颜色空间的标准有多种，我以YCbCr Rec.601标准来讲解。这种颜色空间的原理是，通过三种颜色分量，Y（luma，代表亮度），U（Chroma Blue，Cb，代表蓝色色度），V（Chroma Red，Cr，代表红色色度）三个分量来描述一个颜色。这种描述方式将绿色给去掉了，蓝色和红色分别表示冷色色调与暖色色调。

![alt text](/assets/FFmpeg/01_VideoBasic/image/image-4.png)

这张图估计很多人都会觉得，左边的图像最清晰，中间和右边图像不容易分辨。事实也是这样，人类一般对细节最敏感，但对冷色系和暖色系色调的分辨比较迟钝。

科学家于是想到了一种肉眼很难分辨出的压缩方式，也就是，原本Y，U，V分别一个值代表一个像素，现在两个Y或四个Y共用一个U和一个V。

目前最常用的压缩编码方式是四个Y共用一个U和一个V，这种编码方式相对于RGB来说节省了一半的存储空间。示例像素排列：

### 1.2.1 YUV采样格式

YUV 图像的主流采样方式有如下三种：

- YUV 4:4:4 采样

- YUV 4:2:2 采样

- YUV 4:2:0 采样

#### 1.2.1.1 YUV 4:4:4

YUV 4:4:4 采样，意味着 Y、U、V 三个分量的采样比例相同，因此在生成的图像里，每个像素的三个分量信息完整，都是 8 bit，也就是一个字节。

其中，Y 分量用叉表示，UV 分量用圆圈表示。

![alt text](/assets/FFmpeg/01_VideoBasic/image/image-5.png)

```
举个例子 ：
 
假如图像像素为：[Y0 U0 V0]、[Y1 U1 V1]、[Y2 U2 V2]、[Y3 U3 V3]
 
那么采样的码流为：Y0 U0 V0 Y1 U1 V1 Y2 U2 V2 Y3 U3 V3 
 
最后映射出的像素点依旧为 [Y0 U0 V0]、[Y1 U1 V1]、[Y2 U2 V2]、[Y3 U3 V3]
```

可以看到这种采样方式的图像和 RGB 颜色模型的图像大小是一样，并没有达到节省带宽的目的，当将 RGB 图像转换为 YUV 图像时，也是先转换为 YUV 4:4:4 采样的图像。

#### 1.2.1.2 YUV 4:2:2

YUV 4:2:2 采样，意味着 UV 分量是 Y 分量采样的一半，Y 分量和 UV 分量按照 2 : 1 的比例采样。如果水平方向有 10 个像素点，那么采样了 10 个 Y 分量，而只采样了 5 个 UV 分量。

其中，Y 分量用叉表示，UV 分量用圆圈表示。

![alt text](/assets/FFmpeg/01_VideoBasic/image/image-6.png)

```
举个例子 ：

假如图像像素为：[Y0 U0 V0]、[Y1 U1 V1]、[Y2 U2 V2]、[Y3 U3 V3]

那么采样的码流为：Y0 U0 Y1 V1 Y2 U2 Y3 V3 

其中，每采样过一个像素点，都会采样其 Y 分量，而 U、V 分量就会间隔一个采集一个。

最后映射出的像素点为 [Y0 U0 V1]、[Y1 U0 V1]、[Y2 U2 V3]、[Y3 U2 V3]
```

采样的码流映射为像素点，还是要满足每个像素点有 Y、U、V 三个分量。但是可以看到，第一和第二像素点公用了 U0、V1 分量，第三和第四个像素点公用了 U2、V3 分量，这样就节省了图像空间。

一张 1280 * 720 大小的图片，在 YUV 4:2:2 采样时的大小为：

（1280 * 720 * 8 + 1280 * 720 * 0.5 * 8 * 2）/ 8 / 1024 / 1024 = 1.76 MB

可以看到 YUV 4:2:2 采样的图像比 RGB 模型图像节省了三分之一的存储空间，在传输时占用的带宽也会随之减少。

#### 1.2.1.3 YUV 4:2:0

YUV 4:2:0 采样，并不是指只采样 U 分量而不采样 V 分量。而是指，在每一行扫描时，只扫描一种色度分量（U 或者 V），和 Y 分量按照 2 : 1 的方式采样。比如，第一行扫描时，YU 按照 2 : 1 的方式采样，那么第二行扫描时，YV 分量按照 2:1 的方式采样。对于每个色度分量来说，它的水平方向和竖直方向的采样和 Y 分量相比都是 2:1 。 

如下图所示（其中，Y 分量用叉表示，UV 分量用圆圈表示）：

![alt text](/assets/FFmpeg/01_VideoBasic/image/image-7.png)

假设第一行扫描了 U 分量，第二行扫描了 V 分量，那么需要扫描两行才能够组成完整的 UV 分量。

```
假设图像像素为：

[Y0 U0 V0]、[Y1 U1 V1]、 [Y2 U2 V2]、 [Y3 U3 V3]
[Y5 U5 V5]、[Y6 U6 V6]、 [Y7 U7 V7] 、[Y8 U8 V8]

那么采样的码流为：Y0 U0 Y1 Y2 U2 Y3 Y5 V5 Y6 Y7 V7 Y8

其中，每采样过一个像素点，都会采样其 Y 分量，而 U、V 分量就会间隔一行按照 2 : 1 进行采样。

最后映射出的像素点为：

[Y0 U0 V5]、[Y1 U0 V5]、[Y2 U2 V7]、[Y3 U2 V7]
[Y5 U0 V5]、[Y6 U0 V6]、[Y7 U2 V7]、[Y8 U2 V8]
```

从映射出的像素点中可以看到，四个 Y 分量是共用了一套 UV 分量，而且是按照 2*2 的小方格的形式分布的，相比 YUV 4:2:2 采样中两个 Y 分量共用一套 UV 分量，这样更能够节省空间。

一张 1280 * 720 大小的图片，在 YUV 4:2:0 采样时的大小为：

（1280 * 720 * 8 + 1280 * 720 * 0.25 * 8 * 2）/ 8 / 1024 / 1024 = 1.32 MB 。

可以看到 YUV 4:2:0 采样的图像比 RGB 模型图像节省了一半的存储空间，因此它也是比较主流的采样方式。


### 1.2.3 YUV存储格式

说完了采样，接下来就是如何把采样的数据存储起来。

YUV 的存储格式，有两种：

- planar（平面格式）：指先连续存储所有像素点的 Y 分量，然后存储 U 分量，最后是 V 分量。

- Semi-Planar（半平面格式）：半平面格式具有两个平面而不是三个平面，一个平面存储亮度（Y）分量，另一个平面存储两个色度（UV）分量。有时也将它们称为双平面格式（BiPlanar）。

- packed（打包模式）：指每个像素点的 Y、U、V 分量是连续交替存储的。

根据采样方式和存储格式的不同，就有了多种 YUV 格式。这些格式主要是基于 YUV 4:2:2 和 YUV 4:2:0 采样。


#### 1.2.3.1 Planar平面格式

平面格式有时也称为三面格式（Triplanar），即 Y, U, V 三个分量各自使用单独的数组保存，这种三平面分离的格式比较方便视频编码。


**YU12（I420）**：`4:2:0 Formats, 12 Bits per Pixel, 3 Planars`

YU12 即 I420，也叫 IYUV，属于 YUV420P 格式。三个平面，分别存储 Y U V 分量。每四个 Y 分量共享一组 UV 分量。U、V 平面的 strides, width 和 height 都是 Y 平面的一半，因此一个像素 12 bits，内存排列如下图所示：

![alt text](/assets/FFmpeg/01_VideoBasic/image/image.png)

从图中可看出，U、V 平面的每行字节数（strides）、高（height）都是 Y 平面的一半。`I420` 是音视频开发中常用的一种格式。


**YV12**：`4:2:0 Formats, 12 Bits per Pixel, 3 Planars`

`YV12` 与 `I420` 几乎一样，仅改变了 U, V 平面的顺序。内存排列如下图所示：

![alt text](/assets/FFmpeg/01_VideoBasic/image/image-1.png)

#### 1.2.3.2 Semi-Planar 半平面格式

半平面格式具有两个平面而不是三个平面，一个平面存储亮度（Y）分量，另一个平面存储两个色度（UV）分量。有时也将它们称为双平面格式（BiPlanar）。

**NV12**：`4:2:0 Formats, 12 Bits per Pixel, 2 Planars`

NV12 属于 YUV420SP 格式。两个平面，分别存储 Y 分量 和 UV 分量。其中 UV 分量共用一个平面并且以 U, V, U, V 的顺序交错排列。每四个 Y 分量共享一组 UV 分量。

UV 平面的 strides, width 与 Y 平面一样长，但 height 仅为 Y 平面的一半。因此一个像素 12 bits，内存排列如下图所示：

![alt text](/assets/FFmpeg/01_VideoBasic/image/image-8.png)

从图中可看出，UV 平面的每行字节数（strides）与 Y 平面一致，高（height）是 Y 平面的一半。

NV12 是 iOS 相机（AVCaptureOutput）可直接输出的两种视频帧格式之一，另外一种是 BGRA32(kCVPixelFormatType_32BGRA)。

在 iOS 上，NV12 还分为 Full Range (0-255, kCVPixelFormatType_420YpCbCr8BiPlanarFullRange) 和 Video Range (16-240, kCVPixelFormatType_420YpCbCr8BiPlanarVideoRange)，区别仅为亮度（Y）分量的取值范围，一般而言，Full Range 适用于静态图像（拍照），Video Range 适用于视频采集（摄像）。

**NV21**：`4:2:0 Formats, 12 Bits per Pixel, 2 Planars`

NV21 属于 YUV420SP，与 NV12 几乎一致，区别是 UV 平面中 U 与 V 的排列顺序颠倒，以 V, U, V, U 的顺序交错排列，内存排列如图所示：

![alt text](/assets/FFmpeg/01_VideoBasic/image/image-9.png)

NV21 是 Android 相机（Camera）默认的输出格式。

#### 1.2.3.3 Packed 打包格式

打包格式通常只有一个平面，所有亮度（Y）和色度（UV）数据都交织在一起。有点类似于 RGB 格式，只是使用了不同的色彩空间。

打包格式在网络摄像头中较为常见。硬件设备使用多平面格式效率较低，因为每个像素需要多次内存访问。而打包格式由于仅一个平面，访问内存的开销较小。

**YUYV (V422 / YUY2 / YUNV)**：`4:2:2 Formats, 16 Bits per Pixel`

YUYV 通常也称作 V422、YUY2、YUNV

YUY2 是 Packed 打包格式，其中两个像素共用一组 UV 分量，内存中按照 Y U Y V 的顺序排列，如下图所示：

![alt text](/assets/FFmpeg/01_VideoBasic/image/image-10.png)

**UYVY (Y422 / UYNV)**：`4:2:2 Formats, 16 Bits per Pixel`

UYVY 通常也称作 Y422、UYNV

UYVY 与 YUYV 类似，只是亮度（Y）分量与色度（UV）分量排列顺序颠倒，如下图所示：

![alt text](/assets/FFmpeg/01_VideoBasic/image/image-11.png)


## 参考

[参考1：第一章 视频基础](https://www.fawdlstty.com/ffmpeg/docs/01_video_introduce.html#%E9%A2%9C%E8%89%B2%E7%A9%BA%E9%97%B4)

[参考2：详解 YUV 格式（I420/YUV420/NV12/NV12/YUV422）](https://www.cnblogs.com/thammer/p/17219489.html)
