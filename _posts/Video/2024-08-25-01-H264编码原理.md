---
layout: post
title: 一、H264编码原理
subtitle: 
categories: 音视频原理
tags: 音视频原理
---

H.264码流中没有音频、没有时间戳、除了图像本身信息啥都没有。（没有时间戳，不能正常播放）

mp4 mkv 这些容器加时间戳

NALU：Network Abstraction Layer Unit 网络抽象层单元

![alt text](image.png)

![alt text](image-1.png)

![alt text](image-2.png)


VCL（VideoCoding Layer，视频编码层）：负责高效的视频内容表示。

NAL（NetWorkAbstraction Layer，网络提取层）：负责以网络所要求的恰当方式对数据进行打包和发送。

SODB（String of Data Bits，数据比特串）：最原始的编码数据，即VLC数据，没有任何附加数据。

RBSP（Raw Byte Sequence Payload，原始字节序列载荷）：在SODB的后面填加了结尾比特（RBSP trailing bits），一个bit“1”（表示结尾），若干bit “0”（填充），以便字节对齐；

EBSP （Encapsulation Byte Sequence Packets，扩展字节序列载荷）：在RBSP基础上填加了仿校验字节（0X03）。它的原因是：在NALU加到Annexb上时，需要添加每组NALU之前的开始码StartCodePrefix，如果该NALU对应的slice为一帧的开始则用4位字节表示，ox00000001，否则用3位字节表示ox000001（是一帧的一部分）。解码器检测每个起始码，作为一个NAL的起始标识，当检测到下一个起始码时，当前NAL结束。对于NAL中数据出现0x000001或0x000000时，H.264引入了防止竞争机制，如果编码器遇到两个字节连续为0，就插入一个字节的0x03。解码时将0x03去掉，也称为脱壳操作。

## VCL

VCL层是对核心算法引擎、块、宏块及片的语法级别的定义，最终输出压缩编码后的数据 SODB。VCL数据在传输或存储之前，先被映射或封装进NAL单元中。NAL层将SODB打包成RBSP然后加上NAL头，组成一个NALU（NAL单元）。NAL层定义片级以上的语法级别（如序列参数集和图像参数集，针对网络传输），同时支持以下功能：独立片解码，起始码唯一保证，SEI以及流格式编码数据传送。



H.264标准中，视频流由NAL（NetWork Abstraction Layer）单元组成的（NALU），每个NALU中可能是IDR图像、非IDR图像、SPS或者PPS等。

## 1 AVCC与Annex-B标准

H.264码流分为AVCC与Annex-B两种组织格式。

- AVCC格式 也叫AVC1格式，MPEG-4格式，字节对齐，因此也叫Byte-Stream Format。用于mp4/flv/mkv等封装中。 

- Annex-B格式 也叫MPEG-2 transport stream format格式（ts格式）, ElementaryStream格式。用于TS流中（以及使用TS作为切片的hls格式中）。

这两种格式的区别有两点： 

1. NALU的分割方式不同； 

2. SPS/PPS的数据结构不同。

   - AVCC格式使用NALU长度（固定字节，字节数由extradata中的信息给定）进行分割，在封装文件或者直播流的头部包含extradata信息（非NALU），extradata中包含NALU长度的字节数以及SPS/PPS信息。

   - Annex-B格式使用start code进行分割，start code为0x000001或0x00000001，SPS/PPS作为一般NALU单元以start code作为分隔符的方式放在文件或者直播流的头部。

下图是 `Annex-B` 格式 H.264码流

![alt text](image.png)

## 1 

https://blog.csdn.net/wangbuji/article/details/122528496

https://www.cnblogs.com/wujianming-110117/p/12722286.html

https://www.cnblogs.com/wujianming-110117/p/12722286.html

https://blog.csdn.net/noevil/article/details/132980504

https://blog.csdn.net/xiaoshuaijinniu/article/details/137466012

https://blog.csdn.net/heli200482128/article/details/127161174

https://www.erenship.com/posts/1db7.html

https://cloud.tencent.com/developer/article/1608800

https://cloud.tencent.com/developer/article/1746996