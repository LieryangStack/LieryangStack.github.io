---
layout: post
title: 十、MP4封装
categories: 音视频原理
tags: 音视频原理
---

## 1 概念与术语

1. Box：MP4文件是由一个个Box组成的，可以将其理解为一个数据块，它由Header+Data组成，Data 可以存储媒体元数据和实际的音视频码流数据。Box可直接存储数据块，也可包含其它Box，我们把包含其它Box的Box称为container box。

2. Sample：可理解为采样，对于视频可理解为一帧数据，音频一帧数据就是一段固定时间的音频数据，可以由多个Sample数据组成，存储媒体数据的单位是sample。

3. Chunk：连续几个sample组成的单元被称为chunk，每个chunk在文件中有一个偏移量，整个偏移量从文件头算起，在这个chunk内，sample是连续存储的。

4. Track：表示一些chunk的集合，对于媒体数据而言就是一个视频序列或者音频序列，常说的音频/视频轨可对照该概念上。除了Video Track和Audio Track外，还可以有非媒体数据，比如Hint Track，这种类型的Track就不包含媒体数据，可以包含一些将其他数据打包成媒体数据的指示信息或者字幕信息。简单来说，Track是音视频中可以独立操作的媒体单位。



Trak里面有stream type（使用的是AVC/H.264或者）


![alt text](image.png)

### 2.1 ftyp(File Type Box)

1. ftyp（File Type Box）是一个非常重要的box，它定义了文件类型以及该文件所支持的兼容规范。

2. 该box有且只有1个，并且只能被包含在文件层，而不能被其他box包含。该box应该被放在文件的最开始，指示该MP4文件应用的相关信息。


![alt text](image-1.png)


![alt text](image-2.png)

### 2.2 mdat

实际的音视频数据存储，就是在该容器里面。

### 2.3 moov(Movie Box)

1. moov是一个container box，一个文件只有一个，其包含的所有box用于描述媒体信息（metadata）。描述mdat里面的视频帧或者音频数据是如何播放的。

2. 由于是一个 container box，所以除了 box header，其 box body 就是其它的 box

### 2.3.1 mvhd(Movie Header Box)

1. mvhd 作为媒体信息的 header 出现(注意此header不是box header，而是moov媒体信息的header)，用于描述一些所有媒体共享的基本信息。

2. mvhd 语法继承自fullbox，注意下述示例出现的version和flags字段属于fullbox header






https://blog.csdn.net/m0_60259116/article/details/132714706

https://blog.csdn.net/ProgramNovice/article/details/137641428

https://www.cnblogs.com/ailumiyana/p/12907363.html#ftyp-box

https://zhuanlan.zhihu.com/p/667174320












https://cloud.tencent.com/developer/article/1746996

https://blog.csdn.net/ProgramNovice/article/details/137641428

https://blog.csdn.net/m0_60259116/article/details/132714706

https://blog.csdn.net/u012117034/article/details/123746138


分析工具参考：

https://blog.csdn.net/qq_38998001/article/details/138210509