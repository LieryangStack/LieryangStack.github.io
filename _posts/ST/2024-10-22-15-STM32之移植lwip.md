---
layout: post
title: 十五、STM32——移植lwip
categories: STM32
tags: [STM32]
---


我这里移植的lwip，都是通过STM32CubeMX直接生成，同时含有FreeRTOS系统。所以以下是对CubeMX生成的文件直接描述。

## 1 架构描述

关于源代码文件分为两部分：

1. 接口层文件，跟STM32和PHY芯片有关。STM32芯片不同，PHY芯片不同，这部分文件都会变化。

2. lwip源文件，不进行修改部分，这部分是直接复制lwip。

![alt text](image-5.png)


![alt text](image-4.png)

### 1.1 netif 结构体

1. `netif` 是网口的抽象描述符。netif 结构体是在 `netif.c` 文件中定义的。netif 描述一个网络接口 network interface（网卡）。

2. 单网卡只需要一个netif即可，lwip也实现了多个netif单链表连接的结构，以实现多网卡功能。`netif.c` 定义了 `struct netif *netif_list`。


```c

struct netif {

    /* 指向下一块网卡 */
    struct netif *next;

    /* 该网口的ip地址、子网掩码、默认网关配置 */
    ip_addr_t ip_addr;
    ip_addr_t netmask;
    ip_addr_t gw;

    /* 网卡数据的输入（接收），实际指向的是 tcpip_input */
    netif_input_fn input;

    /* 把网络层数据，包装成链路层数据，负责IP->MAC的转换（ARP），实际指向的是 etharp_output */
    netif_output_fn output;
    
    /* 网卡数据底层（物理层）发送，实际指向的是 low_level_output  */
    netif_linkoutput_fn linkoutput;

    /* 当网络接口的 "IP 配置状态" 发生变化时触发。通常打印新IP地址，在界面上更新网络连接信息 */
    netif_status_callback_fn status_callback;

    /* 当网络接口的 "物理链路状态" 发生变化时触发：网线插拔，PHY 链路状态改变（Link Up / Down） */
    netif_status_callback_fn link_callback;

    /**
     * 表示网络接口的主机名（hostname），主要用于：
     * DHCP 协议中的 DHCP Hostname 选项（Option 12）
     * 有些路由器在 DHCP 客户端连接时，会显示主机名
    */
    const char*  hostname;

    /**
     * 是 LwIP 内部用于标识网络接口的两个字符的“接口简名”
     * 配合接口号（num）形成接口标识，例如：en0、st1、et0、lw0 等
    */
    char name[2];

    /* 如果你设备上有多个网络接口（如多个以太网/WiFi/PPP），每个接口会有一个唯一的 num 值（从 0 开始递增）。 */
    u8_t num;  /* netif_num赋值给num， netif_num 由 netif_add 函数进行加一，每调用一次 netif_num 加一 */
}

```



## 2 PHY芯片之DM9161

汉泰科兴项目中使用的是该芯片，下面是该芯片电路图：

![alt text](/assets/ST/15_lwip/image/image.png)

<font color="red">关于驱动PHY芯片的经验总结：</font>

1. CubeMX生成的 `lan7842.c` 中，`LAN8742_Init` 初始化函数可能无法找到正确的PHY设备地址，可以直接指定PHY地址。（因为两款芯片读取PHY地址寄存器不一样）

    ![alt text](/assets/ST/15_lwip/image/image-1.png)

## 3 DM9000